<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"
      integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
<style>
    #instructions, li {
        color: gray;
    }

    #instructions-inner {
        margin-top: 20px;
    }

    #container {
        position: relative;
    }

    .example-answer {
        color: blue;
    }

    .counterexample-answer {
        color: red;
    }

    #collapse-instructions {
        color: grey;
    }

    .instance {
        border-radius: 15px;
        border: 4px dashed #cee3e9;
        margin-bottom: 10px;
        padding-bottom: 10px;
        padding-left: 40px;
        padding-right: 40px;
        text-align: center;
    }

    .instance-title {
        text-align: center;
    }

    .video {
        display: block;
        height: 360px;
        margin: 10px auto;
    }

    .loading-video {
        position: relative;
        top: 50%;
        text-align: center;
    }

    .video-buttons {
        margin-bottom: 5px;
    }

    .video-button {
        border-radius: 15px;
    }

    .annotate-instructions {
        list-style-type: none;
    }

    .video-relates {
        position: relative;
        text-align: center;
    }

    .answer-label {
        font-size: 1.5rem;
    }

    .answer {
        font-size: 2rem;
        margin: auto auto 20px auto;
        text-align: center;
    }

    .answer-input {
        border: 2px solid #C2C2C2;
        box-shadow: 1px 1px 4px #EBEBEB;
        display: inline-block;
        padding: 5px;
        font-size: 2rem;
        width: 420px;
        height: 40px;
    }

    .answer-input:hover {
        border: 2px solid black;
    }

    .answer-input::placeholder {
        color: lightgray;
    }

    .answers {
        margin-bottom: 20px;
        text-align: center;
    }

    .answer {
        font-size: 1.5rem;
        margin-bottom: 5px;
        margin-right: 10px;
    }

    .remove-answer {
        margin-left: .25rem;
        color: inherit;
        font-size: 100%;
    }

    .remove-answer:hover {
        color: white;
    }

    .alert-answer {
        margin: auto;
        width: 50%;
        text-align: center;
    }

    .answer-instructions {
        list-style-type: none;
        margin-top: 10px;
        text-align: center;
    }

    .reason-list{
      text-align: left;
      padding-left: 40px;
      border: 0 ;
      width: 100%;
    }

    .description {
      color:black;
    }

    .video-progress-bar {
      -webkit-appearance: none;
      background-color: #bdc3c7;
      border-radius: 10px;
      height: 9px;
      width: 50%;
    }

    .video-progress-bar:focus {
      outline: none;
    }

    .character-remain{
      text-align: right;
      color: grey;
      font-weight: bold;
      font-size: 14px;
      margin-top: 5px;
    }

    #comments {
        border-radius: 15px;
        border: 4px dashed #cee3e9;
    }

    textarea {
      text-align: center;
    }

</style>

<div id="container" class="container">
  <h1 id="top">Video Question Answering</h1>

  <details id="instructions">
    <summary>Instructions</summary>

    <div id="instructions-inner">

      <p>We need help for this Video Question Answering task based on video content (including the audio).
      </p>

      <h3>Basic Instructions</h3>

      <ul>
        <li>You will first watch the video, then answer the questions, each question in turn.</li>
        <li>You will need to provide at least one answer for each question (ignoring differences such as upper/lower case, or the article). <b>The more answers the better</b>, but every answer should be correct.</li>
        <li>You will need to identify the source of your answer (whether it is based on the visual scene or the audio).</li>
        <li>For each answer, you will need to provide video evidence (video clip) to support your answers. See below for additional information.</li>
        <li>If one video or question is not available, please <u>comment</u> at the bottom of this annotation page (and fill the mandatory fields for this video/question with placeholder values).          
        </li>
        <li>There are five questions, you need to finish all five questions according to the content in the video (including audio).</li>

      </ul>

      <h3>How To Answer</h3>
      <ul>
        <li>Provide one or more answers for each question.</li>
        <li>Each answer should be written as <b>full sentences</b> (at least one).
          <ul>
            <li>E.g.,<i>&quot;<span class="counterexample-answer">Left</span>&quot;</i> ->
              <i>&quot;<span class="example-answer">The landspout bends toward the left.</span>&quot;</i>
            </li>
          </ul>
        </li>
        <li>
          Respond matter-of-factly (as objectively as possible). Stick to what you can see or hear from the video.
          <ul>
            <li>E.g., <i>&quot;<span class="counterexample-answer">beautiful</span>&quot;</i> is likely <u>not</u> a
              good word to use within an answer.
            </li>
          </ul>
        </li>
        <li>
          When you enter numbers, please enter digits instead of text.

          <ul>
            <li><i>&quot;<span class="counterexample-answer">Seventeen</span>&quot;</i> ->
              <i>&quot;<span class="example-answer">17</span>&quot;</i></li>
          </ul>
        </li>
        <li>Use your best judgment.</li>
      </ul>

      <h3>How to provide video evidence</h3>
      <ul>
        <li>The video evidence consists of <b>all</b> the frame intervals of the video that support the answer to your given question.</li>
        <li> You need to provide at least one video evidence clip (interval within the video) for each question.</li>
        <li> You need to provide both the <b>start point and end point</b> for all the video evidences you identify in the video;</li>
        <li> You can use your mouse or &larr;/&rarr; key to <b>click or drag the process bars</b> of start point and end point. When you click or drag the bar, the above video will change accordingly, so you could locate the points according to the video screen.</li>
        <li> For each video evidence clip, the end point should be <b>greater than zero</b>, and the end point should be greater or equal to the start point.</li>
        <li> The video evidence clips (the time gap between the start point and the end point) should only cover the actual evidence and not more (in other words, it should be <span class="example-answer">as short as possible</span>).</li>
      </ul>

      <h3>Example</h3>
      
      <div id="example"></div>

      <button type="button" class="btn" id="collapse-instructions" onclick="collapseInstructions()">
        &#x25B2 Collapse instructions
      </button>
    </div>
  </details>

  <hr>

  <crowd-form onsubmit="return checkValid()">
    <div id="instances"></div>

    <div class="form-group">
      <label for="comments">Comments:</label>
      <textarea class="form-control" id="comments" name="comments" rows="10"
                placeholder="Please, write any comment/error/suggestion you have."></textarea>
    </div>

    <crowd-button id="submit-button" form-action="submit" variant="primary">Submit</crowd-button>
  </crowd-form>
</div>

<script src="https://assets.crowd.aws/crowd-html-elements.js"></script>
<script src="https://code.jquery.com/jquery-3.5.1.min.js"
        integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx"
        crossorigin="anonymous"></script>
<!--suppress CommaExpressionJS -->
<script type="text/javascript">
  // JS string interpolations clash with the Amazon Mechanical Turk template system, as they both use the syntax ${...}.
  // So we do a trick which is to put the simple string interpolation of variables inside a comma operator expression,
  // which always returns the last operand. For example, if we have to interpolate the variable "i" inside the backticks
  // (`) then we do `${0, i}`. This is basically the minimum we can write as far as we know.
  // Complex expressions usually don't need this. I tried other variants, but it seems that AMT captures spaces and plus
  // signs as valid syntax. The ternary operator is another option (`${1 ? i : 0}`), though more verbose.

  const ENTER_KEY_CODE = 13;
  const BACKSPACE_KEY_CODE = 8;
  const MAX_ANSWER_LEN = 500;

  // const videos = ["https://www.dropbox.com/s/xaw3bbhx5bmahqn/Dan-Robinson_10-clip-0.mp4?raw=1", 
  //   "${video1}", "${video2}"]
  const videos = ["https://www.dropbox.com/s/xaw3bbhx5bmahqn/Dan-Robinson_10-clip-0.mp4?raw=1", 
    "${video1}", "${video2}", "${video3}", "${video4}", "${video5}"]
      .map(v => templateWasSubstituted(v) ? v :
       "https://www.dropbox.com/s/xaw3bbhx5bmahqn/Dan-Robinson_10-clip-0.mp4?raw=1");
  // const questions = ["Which direction does the landspout bend toward?", 
  //   "${question1}", "${question2}"]
  const questions = ["Which direction does the landspout bend toward?", 
    "${question1}", "${question2}", "${question3}", "${question4}", "${question5}"]
      .map(v => templateWasSubstituted(v) ? v :
       "Which direction does the landspout bend toward?").map(escapeHtml);

  function templateWasSubstituted(s) {
    return !s.startsWith("${") || !s.endsWith("}");
  }

  // From https://stackoverflow.com/a/6234804/1165181
  function escapeHtml(unsafe) {
    return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        // Use single quotes as AMT expands the double quote escaping and gives a syntax error otherwise:
        .replace(/"/g, '&quot;')
        .replace(/'/g, "&#039;");
  }

  function createInstanceElement(i, isExample, title, video, question) {
    return $(`
        <div class="instance" id="instance-${0, i}">
          <b><h1 class="instance-title">${0, title}</h1></b>
          <div class="video" id="video-${0, i}">
            <video style="max-width:80%;max-height:100%" src=${0,video} controls> </video>
          </div>
        </br>
          <div class="video-relates">
            <ul class="annotate-instructions">
                <li>
                  Please carefully read the
                <a href="#instructions">instructions</a> before performing the task.
                </li>
                <li>
                  Watch this video while you listen to its <b><u>audio</u></b> (you
                  may need to adjust your <b>device volume</b>).
                </li>
                <li>
                  When the video ends, <b>do not</b> click on any other video. Place your mouse on the video, control buttons will then appear.
                </li>
              </ul>
          </div>
            
          <hr>

          <div class="form-group">
            <h4>Question${isExample? "-Example":`-${0,i}`}:</h4></br>
             <h5>${0,question}<h5></br>
          </div>

          <hr>

          <div id="inner-answers-${0,i}"></div>

        </div>`);
  }


  function createAnswerElement(i, j, isExample, isDeletable, video) {
    return $(`
        <div class="inner-answer" name="inner-answer-${0,i}" id="inner-answer-${0,i}-${0,j}">
          ${j==0? "":"</br><hr style=\"border: 2px dashed #cee3e9;\">"}

          ${ isDeletable?`<button type="button" class="btn btn-danger" 
          id="delete-answer-${0,i}-${0,j}" ${isExample? "disabled":""} > click here to <u>Delete</u> this Answer </button>`:""}

          <h3> Question${isExample? "-Example":`-${0,i}`} Answer-${0,j+1} </h3>
          
          <br>
          <div class="form-group">
            <h4>Your Answer:</h4>
             <textarea class="form-control" id="answer-input-${0, i}-${0,j}" name="answer-input-${0, i}-${0,j}" 
              rows="3" placeholder="Please type your answer here" 
              ${isExample? "disabled" :""}>${isExample? "The landspout bends toward the left.":""}</textarea>
            <div id="remain-character-${0,i}-${0,j}" class="character-remain">
              ${isExample? `${0,MAX_ANSWER_LEN-"The landspout bends toward the left.".length}/${0,MAX_ANSWER_LEN} characters remaining`:`${0,MAX_ANSWER_LEN}/${0,MAX_ANSWER_LEN} characters remaining`}
            </div>
            <ur class="annotate-instructions">
              <li>Your answer should be written as <b>full sentences</b> (at least one).</li>
              <li>Respond matter-of-factly (as objectively as possible). Stick to what you can see or hear from the video.</li>
            </ur>
          </div>

          <hr>

          <div>
            <h4>What is your answer based on: (Check all that apply):</h4>
            <br>
            <div>
              <input type="checkbox" name="answer-based-${0, i}-${0,j}" id="answer-based-scene-${0, i}-${0,j}" 
              value="scene"/ ${isExample? "disabled checked":""}>
              <label for="answer-based-scene-${0, i}-${0,j}">Scene </label>
              <input type="checkbox" name="answer-based-${0, i}-${0,j}" id="answer-based-audio-${0, i}-${0,j}" 
              value="audio"/ ${isExample? "disabled":""}>
              <label for="answer-based-audio-${0, i}-${0,j}">Audio </label>
            </div>
          </div>

          <hr>

          <div class="form-group">
            <h5>Please suggest how confident you are with your answer:</h5>
            <br>
            <div>
              <input type="radio" name="confidence-${0, i}-${0, j}" id="confidence-veryhigh-${0, i}-${0, j}" 
              value="very_high" ${isExample? "disabled":""} />
              <label for="confidence-veryhigh-${0, i}-${0, j}">Very High Confidence</label>
              <input type="radio" name="confidence-${0, i}-${0, j}" id="confidence-high-${0, i}-${0, j}" 
              value="high" ${isExample? "checked disabled":""} />
              <label for="confidence-high-${0, i}-${0, j}">High Confidence</label>
              <input type="radio" name="confidence-${0, i}-${0, j}" id="confidence-moderate-${0, i}-${0, j}" 
              value="moderate" ${isExample? "disabled":""} />
              <label for="confidence-moderate-${0, i}-${0, j}">Moderate Confidence</label>
              <input type="radio" name="confidence-${0, i}-${0, j}" id="confidence-low-${0, i}-${0, j}" 
              value="low" ${isExample? "disabled":""} />
              <label for="confidence-low-${0, i}-${0, j}">Low Confidence</label>
              <input type="radio" name="confidence-${0, i}-${0, j}" id="confidence-verylow-${0, i}-${0, j}" 
              value="very_low" ${isExample? "disabled":""} />
              <label for="confidence-verylow-${0, i}-${0, j}">Very Low Confidence</label>
            </div>
          </div>

          <hr>

          <div class="video-evidence" id="video-evidence-${0,i}-${0,j}">
            <h4>Locate video evidences to support your answer:</h4>
            <video style="max-width:50%;max-height:100%" src=${0,video} id="refer-video-${0,i}-${0,j}" controls> </video>
            <ur class="annotate-instructions">
              <li>The video evidence consists of <b>all</b> the frame intervals of the video that support the answer to your given question.</li>
              <li> You need to provide at least one video evidence clip (interval within the video) for one question.</li>
              <li> You need to provide both the <b>start point and end point</b> for all the video evidences you identify in the video;</li>
              <li> You can use your mouse or &larr;/&rarr; key to <b>click or drag the process bars</b> of start point and end point.</li>
              <li> For each video evidence clip, the end point should be <b>greater than zero</b>, and the end point should be greater or equal to the start point.</li>
              <li> The video evidence clips (the time gap between the start point and the end point) should only cover the actual evidence and not more (in other words, it should be <b>as short as possible</b>).</b></li>
            </ur>

            <div id="video-bars-${0,i}-${0,j}"></div>
            
          </div>
          <hr>

          <div class="alert alert-warning alert-answer" id="alert-${0,i}-${0,j}"></div></br>

         <button type="button" name="create-answer-${0,i}" class="btn btn-info" id="create-answer-${0,i}-${0,j}" ${isExample? "disabled":""} >
          click here to <font size="4"><b>Add one more<b></font> answer for this question</button>
        </div>`
    )
  }

  function createBarElement(i, j, k, isExample, isDeletable, isAddable){
    return $(`
    <div class="video-bar" name="video-bar-${0, i}-${0, j}" id="video-bar-${0, i}-${0, j}-${0, k}">
      ${isDeletable? "<hr>":""}

      <label for="start-bar-${0, i}-${0, j}-${0, k}">Start point: </label> <input type="range" class="video-progress-bar" name="start-bar-${0, i}-${0, j}-${0, k}" id="start-bar-${0, i}-${0, j}-${0, k}"
        ${isExample? "disabled value=20.56" :"value=0"} max="100" step="0.08"><br>
      <label for="end-bar-${0, i}-${0, j}-${0, k}">End &nbsp;point: </label> <input type="range" class="video-progress-bar" name="end-bar-${0, i}-${0, j}-${0, k}" id="end-bar-${0, i}-${0, j}-${0, k}" 
        ${isExample? "disabled value=20.96" :"value=0"} max="100" step="0.08"><br>
      
      ${ isDeletable?`<button type="button" class="btn btn-danger" 
        name="delete-bar-${0,i}-${0, j}" id="delete-bar-${0,i}-${0, j}-${0,k}" style=" height:30px; padding-top:4px;" ${isExample? "disabled":""} > Click here to <u>Delete</u> this video evidence</button>`:""}
      ${ isAddable?`<button type="button" class="btn btn-success"
        name="create-bar-${0,i}-${0, j}" id="create-bar-${0,i}-${0, j}-${0,k}" style=" height:30px; padding-top:4px;" ${isExample? "disabled":""} > Click here to <font size="3"><b>Add one more</b></font> video evidence</button>`:""}
    </div>
    `);
  }

  function insertBarElement(i, j, k, isExample){
    const isDeletable = k > 0;
    const isAddable = Array.from($(`[name="video-bar-${0, i}-${0, j}"]`)).length <= 1000;
    createBarElement(i, j, k, isExample, isDeletable, isAddable).appendTo(`#video-bars-${0, i}-${0, j}`);
    $(`#create-bar-${0, i}-${0, j}-${0,k}`).click(() => {
      const $videobarsarray = Array.from($(`[name="video-bar-${0, i}-${0, j}"]`));
      insertBarElement(i,j,parseInt($videobarsarray[$videobarsarray.length-1].id.split("-")[4]) + 1, isExample);
      document.getElementById(`create-bar-${0, i}-${0, j}-${0,k}`).disabled = true;
      checkValidationAlerts(i,j);
      });
    $(`#delete-bar-${0, i}-${0, j}-${0, k}`).click(() => {
      if (confirm(`Do you really want to delete this video evidence?`)==true){
        const $createbarsarray = Array.from($(`[name="create-bar-${0, i}-${0, j}"]`));
        if($createbarsarray[$createbarsarray.length-1].id.split("-")[4] == k){ // delete last addable bar
          $createbarsarray[$createbarsarray.length-2].disabled = false;
        }
        else{
          if($createbarsarray[$createbarsarray.length-1].disabled == true){ // activate last addable bar
            $createbarsarray[$createbarsarray.length-1].disabled = false;
          }
        }

        const obj =  document.getElementById(`video-bar-${0, i}-${0, j}-${0,k}`);
        const objparent = obj.parentNode;
        objparent.removeChild(obj);
      }
      checkValidationAlerts(i,j);
    });
    setUpVideoListeners();
  }

  function insertAnswerElement(i, j, isExample, video){
    const isDeletable = j > 0;
    createAnswerElement(i, j, isExample, isDeletable, video).appendTo(`#inner-answers-${0,i}`);
    insertBarElement(i, j, 0, isExample);
    $(`#create-answer-${0,i}-${0,j}`).click(() => {
      const $answersarray = Array.from($(`[name="inner-answer-${0,i}"]`));
      insertAnswerElement(i, parseInt($answersarray[$answersarray.length-1].id.split("-")[3]) + 1, isExample, video);
      document.getElementById(`create-answer-${0,i}-${0,j}`).disabled = true;
      });
    $(`#delete-answer-${0,i}-${0,j}`).click(() => {
      if (confirm(`Do you really want to delete Video-${0,i} Answer-${0,j+1} ?`)==true){
        const $createanswersarray = Array.from($(`[name="create-answer-${0,i}"]`));
        if($createanswersarray[$createanswersarray.length-1].id.split("-")[3] == j){ // delete last addable answer
          $createanswersarray[$createanswersarray.length-2].disabled = false;
        }
        else{
          if($createanswersarray[$createanswersarray.length-1].disabled == true){ // activate last addable answer
            $createanswersarray[$createanswersarray.length-1].disabled = false;
          }
        }

        const obj =  document.getElementById(`inner-answer-${0,i}-${0,j}`);
        const objparent = obj.parentNode;
        objparent.removeChild(obj);
        activateCheckAnswers(i);
      }
    });
    setUpInputListeners();
    setUpVideoListeners();
  }

  function createInstances() {
    videos.forEach((video, i) => {
      const isExample = i === 0;
      const title = isExample ? "Example" : `Video ${0, i}`;
      const parentId = isExample ? "example" : "instances";
      createInstanceElement(i, isExample, title, video, questions[i]).appendTo(`#${0, parentId}`);
      insertAnswerElement(i, 0, isExample, video);
    });
  }

  function collapseInstructions() {
    $("#instructions").removeAttr("open");
    window.location = "#top";
  }

  function normalizeAnswer(answer) {
    return $.trim(
        answer
            .toLowerCase()
            .replace(/[!"#$%&'()*+,\-./:;<=>?@\[\\\]^_`{|}~]/g, "")  // Same as in Python's `string.punctuation`.
            .replace(/\b(?:an?|the)\b/g, "")
    );
  }

  function answerCompleted(i,j) {
    const i_value = normalizeAnswer(document.getElementById(`answer-input-${0,i}-${0,j}`).value);
    if (!i_value) { // empty or only with punctuations
      return false;
    }
    const i_answers = new Set(
      $(`[name^=answer-input-${0,i}][name!=answer-input-${0,i}-${0,j}]`)
            .toArray()
            .map($e => $e.value)
            .map(normalizeAnswer)
      );
    return !i_answers.has(i_value);
  }

  function basedCompleted(i,j){
    return $(`[name="answer-based-${0,i}-${0,j}"]:checked`).length > 0;
  }

  function confidenceCompleted(i,j) {
    return $(`[name="confidence-${0,i}-${0,j}"]:checked`).length > 0;
  }

  function evidenceCompleted(i,j,k) {
    const $startbar_value = parseFloat(document.getElementById(`start-bar-${0, i}-${0, j}-${0, k}`).value);
    const $endbar_value = parseFloat(document.getElementById(`end-bar-${0, i}-${0, j}-${0, k}`).value);
    return ($endbar_value > 0) && ($startbar_value <= $endbar_value);
  }

  function evidencesCompleted(i,j) {
    return Array.from($(`[name="video-bar-${0, i}-${0, j}"]`)).map((eveele,) => {
      const k = eveele.id.split("-")[4];
      return evidenceCompleted(i,j,k);
    }).every(Boolean);
  }

  function blankCompleted(i,j) {
    return  answerCompleted(i,j) && basedCompleted(i,j) && confidenceCompleted(i,j) && evidencesCompleted(i,j);
  }

  function videoCompleted(i) {
    return Array.from($(`[name="inner-answer-${0, i}"]`)).map((ansele,_) => {
      const j = ansele.id.split("-")[3];
      return blankCompleted(i,j);
    }).every(Boolean);
  }

  function checkValid() {
    const completed = videos.map((_, i) => {
      const completi = videoCompleted(i);
      Array.from($(`[name="inner-answer-${0, i}"]`)).map((queele,_) => {
        const j = queele.id.split("-")[3];
        const message1 = "The answer is either empty or already provided.";
        const message2 = "Please choose at least one option."
        const message5 = "Please select your confidence level for your correct answer."
        const message6 = "Please finish the video evidence part.\nMake sure the end time > 0.\nMake sure the end time >= the start time.";
        document.getElementById(`answer-input-${0,i}-${0,j}`).setCustomValidity(answerCompleted(i,j)? "" : message1);
        document.getElementById(`answer-based-scene-${0,i}-${0,j}`).setCustomValidity(basedCompleted(i,j)? "" : message2);
        document.getElementById(`confidence-high-${0,i}-${0,j}`).setCustomValidity(confidenceCompleted(i,j)? "" : message5);
        Array.from($(`[name="video-bar-${0, i}-${0, j}"]`)).map((eveele,) => {
          const k = eveele.id.split("-")[4];
          document.getElementById(`start-bar-${0, i}-${0, j}-${0, k}`).setCustomValidity(evidenceCompleted(i, j, k)? "" : message6);
        });
      });
      return completi;
    }).every(Boolean);

    document.getElementsByTagName("form")[0].reportValidity();

    return completed;
  }

  function checkValidationAlerts(i,j) {
    const $errorMessage = $(`#alert-${0,i}-${0,j}`);
    if (blankCompleted(i,j)) {
      $errorMessage.fadeOut("fast");
    } else {
      $errorMessage.text("Please finish above fill-in and classification tasks.").fadeIn();
    }
  }

  function activateCheckAnswers(i){
    Array.from($(`[name="inner-answer-${0, i}"]`)).map((ans,_) => {
      const tj = ans.id.split("-")[3];
      document.getElementById(`answer-input-${0, i}-${0, tj}`).setCustomValidity("");
      $(document.getElementById(`answer-input-${0, i}-${0, tj}`)).removeClass("is-invalid");
      checkValidationAlerts(i,tj);
    });
  }

  function countRemainCharacters(i,j){
    const inputfield = document.getElementById(`answer-input-${0,i}-${0,j}`);
    const countfield = document.getElementById(`remain-character-${0,i}-${0,j}`);
    if (inputfield.value.length > MAX_ANSWER_LEN) {
      inputfield.value = inputfield.value.substring(0, MAX_ANSWER_LEN);
    } else {
      countfield.textContent = `${0,MAX_ANSWER_LEN-inputfield.value.length}/${0,MAX_ANSWER_LEN} characters remaining`;
    }
  }

  function setUpInputListeners() 
  {
    videos.forEach((_, i) => {
      Array.from($(`[name="inner-answer-${0, i}"]`)).map((queele,_) => {
        const j = queele.id.split("-")[3];
        $(`[name="answer-input-${0,i}-${0, j}"]`).keyup(e => {
            countRemainCharacters(i,j);
            activateCheckAnswers(i);
            checkValidationAlerts(i,j);
          });

        Array.from($(`[name="answer-based-${0, i}-${0, j}"]`)).forEach(rease => 
        { $(rease).click(e => 
          {
            document.getElementById(`answer-based-scene-${0, i}-${0, j}`).setCustomValidity("");
            $(document.getElementById(`answer-based-scene-${0, i}-${0, j}`)).removeClass("is-invalid");
            checkValidationAlerts(i,j);
          });
        });

        Array.from($(`[name="confidence-${0, i}-${0, j}"]`)).forEach(rease => 
        { $(rease).click(e => 
          {
            document.getElementById(`confidence-high-${0, i}-${0, j}`).setCustomValidity("");
            $(document.getElementById(`confidence-high-${0, i}-${0, j}`)).removeClass("is-invalid");
            checkValidationAlerts(i,j);
          });
        });

        checkValidationAlerts(i,j);
      });
    });
  }

  function setUpVideoListeners() {
    videos.forEach((_, i) => {
      Array.from($(`[name="inner-answer-${0, i}"]`)).map((queele,_) => {
        const j = queele.id.split("-")[3];
        Array.from($(`[name="video-bar-${0, i}-${0, j}"]`)).map((eveele,) => {
          const k = eveele.id.split("-")[4];
          const $videoi = document.getElementById(`refer-video-${0, i}-${0, j}`);
          const $startbari = document.getElementById(`start-bar-${0, i}-${0, j}-${0, k}`);
          const $endbari = document.getElementById(`end-bar-${0, i}-${0, j}-${0, k}`);

          $($startbari).mousedown(e =>{
            $videoi.pause();
            $startbari.setCustomValidity("");
            $($startbari).removeClass("is-invalid");
            $startbari.onmousemove=function(){
              $videoi.currentTime = parseFloat($startbari.value) / 100 * parseFloat($videoi.duration);
            }
            $startbari.onmouseup=function(){
              $videoi.currentTime = parseFloat($startbari.value) / 100 * parseFloat($videoi.duration);
              checkValidationAlerts(i,j);
              $startbari.onmouseup=null;
              $startbari.onmousemove=null;
            }
            checkValidationAlerts(i,j);
          });
          $($startbari).keydown(e => {
            if (e.keyCode === 37 || e.keyCode === 39){
              $videoi.currentTime = parseFloat($startbari.value) / 100 * parseFloat($videoi.duration);
              $startbari.setCustomValidity("");
              $($startbari).removeClass("is-invalid");
            }
            checkValidationAlerts(i,j);
          });
        
          $($endbari).mousedown(e =>{
            $videoi.pause();
            $startbari.setCustomValidity("");
            $($startbari).removeClass("is-invalid");
            $endbari.onmousemove=function(){
              $videoi.currentTime = parseFloat($endbari.value) / 100 * parseFloat($videoi.duration);
            }
            $endbari.onmouseup=function(){
              $videoi.currentTime = parseFloat($endbari.value) / 100 * parseFloat($videoi.duration);
              checkValidationAlerts(i,j);
              $endbari.onmousemove=null;
              $endbari.onmouseup=null;
            }
            checkValidationAlerts(i,j);
          });
          $($endbari).keydown(e => {
            if (e.keyCode === 37 || e.keyCode === 39){
              $videoi.currentTime = parseFloat($endbari.value) / 100 * parseFloat($videoi.duration);
              $startbari.setCustomValidity("");
              $($startbari).removeClass("is-invalid");
            }
            checkValidationAlerts(i,j);
          });
        });
      });
    });
  }

  function onDomContentLoaded() {
    createInstances();
    setUpInputListeners();
    setUpVideoListeners();
  }

  function main() {
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", onDomContentLoaded);
    } else {
      onDomContentLoaded();
    }
  }

  main();
</script>
