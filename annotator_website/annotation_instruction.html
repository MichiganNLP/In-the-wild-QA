<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"
      integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
<style>
    #instructions, li {
        color: gray;
    }

    #instructions-inner {
        margin-top: 20px;
    }

    #container {
        position: relative;
    }

    .example-answer {
        color: blue;
    }

    .counterexample-answer {
        color: red;
    }textarea

    #collapse-instructions {
        color: grey;
    }

    .instance {
        border-radius: 15px;
        border: 4px dashed #cee3e9;
        margin-bottom: 10px;
        padding-bottom: 10px;
        padding-left: 40px;
        padding-right: 40px;
        text-align: center;
    }

    .instance-title {
        text-align: center;
    }

    .video {
        display: block;
        height: 360px;
        margin: 10px auto;
    }

    .loading-video {
        position: relative;
        top: 50%;
        text-align: center;
    }

    .video-buttons {
        margin-bottom: 5px;
    }

    .video-button {
        border-radius: 15px;
    }

    .video-instructions {
        list-style-type: none;
    }

    .video-relates {
        position: relative;
        text-align: center;
    }

    .question-label {
        font-size: 1.3rem;
    }

    .question {
        font-size: 2rem;
        margin: auto auto 20px auto;
        text-align: center;
    }

    .answer-input {
        border: 2px solid #C2C2C2;
        box-shadow: 1px 1px 4px #EBEBEB;
        display: inline-block;
        padding: 5px;
        font-size: 2rem;
        width: 1000px;
        height: 40px;
    }

    .answer-input:hover {
        border: 2px solid black;
    }

    .answer-input::placeholder {
        color: lightgray;
    }

    .answers {
        margin-bottom: 20px;
        text-align: center;
    }

    .answer {
        font-size: 1.5rem;
        margin-bottom: 5px;
        margin-right: 10px;
    }

    .remove-answer {
        margin-left: .25rem;
        color: inherit;
        font-size: 100%;
    }

    .remove-answer:hover {
        color: white;
    }

    .alert-answer {
        margin: auto;
        width: 50%;
        text-align: center;
    }

    .answer-instructions {
        list-style-type: none;
        margin-top: 10px;
        text-align: center;
    }

    #comments {
        border-radius: 15px;
        border: 4px dashed #cee3e9;
    }

    .yt {
    position: relative;
    display: block;
    width: 90%; /* width of iframe wrapper */
    height: 0;
    margin: auto;
    padding: 0% 0% 56.25%; /* 16:9 ratio */
    overflow: hidden;
    }

    .yt iframe {
    position: absolute;
    top: 0; bottom: 0; left: 0;
    width: 100%;
    height: 100%;
    border: 0;
    }
</style>

<div id="container" class="container">
  <h1 id="top">Fill in the blanks according to video content</h1>

  <details id="instructions">
    <summary>Instructions (including information on <b>bonuses</b>)</summary>

    <div id="instructions-inner">

      <p>We need help answering (&quot;filling&quot;) these blanks based on video content (including the audio).</p>

      <h2>Basic Instructions</h2>

      <ul>
        <li>You need to write questions with regard to the content in video. Please utilze the description for the video if description exists.
            
        <li>You need to identify the source of your question (whether it is based on scene, audio, video description) and classify your questions.</li>
            
        <li>You need to provide correct answer to the question you asked and three incorrect answers (related to the video content but is not the 
            correct answer to the question you asked)</li>
      </ul>

      <h2>How To Ask Your Question</h2>

      Questions you ask should utilize the professional terminologies in the video description if possible.

      <ul>
        <li>An example is as follows:</li>
        <iframe src="https://drive.google.com/file/d/1q9-aoCsKTzXL5asNNJ8wNaJDmob5LWrG/preview" width="640" height="480" allow="autoplay"></iframe>
        <ul>
            <li><b>Original Question:</b> What is the target of the <span class="example-answer">tank</span> after it gets close to the river?</li>
            <li><b>Video description:</b> US military <span class="example-answer">M1 Abrams tanks</span> ... </li>
            <li><b>Your Question (using description):</b> What is the target of the <span class="example-answer">M1 Abrams tank</span> after it gets close to the river?</li>
        </ul>

      </ul>

      <h2>How To Identity Question Category</h2>

      We have four basic categories <b>Motion</b>, <b>Spatial Relationship</b>, <b>Temporal Relationship</b>, <b>Free Form</b>. We give their definitions as follows:

      <ul>
          <li><b>Motion:</b> Questions ask motion of certain object in the video. </li>
          <li><b>Spatial Relationship:</b> Questions involve the spatial relationship of objects. Common patterns in this type include &quot;on the left of&quot;, &quot;next to&quot; </li>
          <li><b>Temporal Relationship:</b> Questions involve temporal information about the video. Common patterns in this type include &quot;before&quot;</li>
          <li><b>Free Form:</b> Other types of questions. You need to write a category yourself if you think your question is in this type. Possible subtypes of free form questions include: reasoning, number, object, time, location, others. </li>
      </ul>

      If your questions fall into <b>multiple categories</b>, please <u>check all categories that apply</u>.
      <p>Here are some examples of questions under each category:</p>
      <ul>
          <li><b>Motion:</b> What are the group of soldiers <span class="example-answer">doing</span>?</li>
          <li><b>Spatial Relationship:</b> What is driving <span class="example-answer">beside</span> the motorcycle?</li>
          <li><b>Temporal Relationship:</b> What happens <span class="example-answer">before</span> the black smoke rises?</li>
          <li><b>Free Form:</b><ul>
              <li><b>Reasoning:</b> <span class="example-answer">What makes</span> changing between targets <span class="example-answer">possible</span> for the missile?</li>
              <li><b>Number:</b> <span class="example-answer">How many</span> fighters are flying?</li>
              <li><b>Object:</b> <span class="example-answer">What is the target</span> of the bullet?</li>
              <li><b>Time:</b> <span class="example-answer">How long</span> can the missle fly?</li>
              <li><b>Location:</b> <span class="example-answer">Where</span> is the tank?</li>
              <li><b>Others:</b> What does the man require the warship to do?</li>
          </ul></li>
      </ul>

      <h2>HIT Acceptance</h2>

      Your HIT will be accepted based on:
      <ul>
          <li>How well your question <u>related to the video content</u></li>
          <li>Whether your question <u>involves professional terms provided in the video description</u> if possible</li>
      </ul>

      <h2>Bonuses</h2>

      Need to be discussed.

      <!-- <ul>
        <li>
          There are 2 types of bonuses:

          <ol>
            <li>
              You will receive a 1st type of bonus for each correct answer, with the following rules. We will evaluate
              each answer, and compute the number of correct answers (the ones that comply with the above rules).

              For every HIT, 10 correct answers are considered to be covered by the regular HIT pay (2 for each
              of the 5 blanks per HIT). For every extra correct answer you will receive this bonus, for up to 3 answers
              per blank. In other words, if you have 5 correct answers per blank, you will receive the maximum amount
              for this type of bonus (3 extra correct answers * 5 blanks = 15x the bonus value).

              The value of the bonus for each correct answer is the HIT pay amount divided by 10 (2 * 5 blanks per HIT).
              You could get up to 15 times this value for every HIT.

              With this, we want to encourage people to answer as many different answers they can come up with,
              up to a reasonable amount. Don't worry if you can't come up with 5, because if you spend a lot of time
              in a blank then it's probably not worth it.

              Remember the answers have to be correct, otherwise not only you risk not getting the bonus but also
              getting your HITs rejected.
            </li>
            <li>
              For each HIT, the worker with the largest amount of correct answers will receive a 2nd type of bonus.
              This bonus value is the same as the HIT pay amount (the HIT pay amount not considering the 1st type of
              bonus value).

              We want to encourage workers to answer as many as they can.
            </li>
          </ol>
        </li>
        <li>
          With these 2 types of bonus, we encourage the following way of answering. Go to every blank, watch the
          video, read the text with the blank, and try to answer the blank with as many different answers you can
          come up to, even beyond 5 (because you could get the 2nd type of bonus). If many seconds pass and you can't
          come up with more answers, then just move on to the next blank because it's probably not worth it
          to spend a lot of time in each blank.
        </li>
        <li>
          The bonuses will be paid once all the annotations from all the workers has been submitted and reviewed.
        </li> -->
      </ul>

      <div id="example"></div>

      <button type="button" class="btn" id="collapse-instructions" onclick="collapseInstructions()">
        &#x25B2 Collapse instructions
      </button>
    </div>
  </details>

  <hr>

  <crowd-form onsubmit="return checkValid()">
    <div id="instances"></div>

    <div class="form-group">
      <label for="comments">Comments:</label>
      <textarea class="form-control" id="comments" name="comments" rows="10"
                placeholder="Please, write any comment/error/suggestion you have."></textarea>
    </div>

    <crowd-button id="submit-button" form-action="submit" variant="primary">Submit</crowd-button>
  </crowd-form>
</div>

<script src="https://assets.crowd.aws/crowd-html-elements.js"></script>
<script src="https://code.jquery.com/jquery-3.5.1.min.js"
        integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx"
        crossorigin="anonymous"></script>
<!--suppress CommaExpressionJS -->
<script type="text/javascript">
  // JS string interpolations clash with the Amazon Mechanical Turk template system, as they both use the syntax ${...}.
  // So we do a trick which is to put the simple string interpolation of variables inside a comma operator expression,
  // which always returns the last operand. For example, if we have to interpolate the variable "i" inside the backticks
  // (`) then we do `${0, i}`. This is basically the minimum we can write as far as we know.
  // Complex expressions usually don't need this. I tried other variants, but it seems that AMT captures spaces and plus
  // signs as valid syntax. The ternary operator is another option (`${1 ? i : 0}`), though more verbose.

  const ENTER_KEY_CODE = 13;

  const exampleAnswers = ["beer", "a glass of beer"];

  // we use Google drive video ids instead
  const videoIds = ["1WsdfOmM5L-7aXjyuxSqouYVkpNxXx4Lt", "${video1_id}"]
      .map(v => templateWasSubstituted(v) ? v : "1WsdfOmM5L-7aXjyuxSqouYVkpNxXx4Lt");
  const descriptions = ["N/A", "${video1_description}"]
      .map(v => templateWasSubstituted(v) ? v : "N/A");

  const questions = ["_____", "${question1}"]
      .map((q, i) => templateWasSubstituted(q) ? q : "_____")
      .map(q => {
        const maskPosition = q.indexOf("_____");
        console.assert(maskPosition !== -1 && maskPosition === q.lastIndexOf("_____"))
        return q;
      })
      .map(escapeHtml)
      .map((q, i) => q.replace("_____",
          `<input type="text" class="form-control answer-input" id="answer-input-${0, i}"
                  name="answer-input-${0, i}"
                  placeholder="type a question" ${i === 0 ? "disabled" : ""}>`));

  console.assert(videoIds.length === questions.length);
  console.assert(questions.every(q => q))

  let players = [];

  function templateWasSubstituted(s) {
    return !s.startsWith("${") || !s.endsWith("}");
  }

  // From https://stackoverflow.com/a/6234804/1165181
  function escapeHtml(unsafe) {
    return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        // Use single quotes as AMT expands the double quote escaping and gives a syntax error otherwise:
        .replace(/"/g, '&quot;')
        .replace(/'/g, "&#039;");
  }


  function createInstanceElement(i, isExample, title, question, showNextButton, video_id, description) {
    return $(`
        <div class="instance" id="instance-${0, i}">
          <h2 class="instance-title">${0, title}</h2>
          <div class="class" id="video-${0, i}">
            <div class="yt">
            <iframe src="https://drive.google.com/file/d/${"1WsdfOmM5L-7aXjyuxSqouYVkpNxXx4Lt", video_id}/preview" allow="autoplay"></iframe>
            </div>
          </div>
          <div class="video-relates">
            <ul class="description">
                <b> Description </b>: ${0, description}
            </ul>
            <ul class="video-instructions">
              <li>
                Please watch this video while you listen to its <b><u>audio</u></b> (you
                may need to adjust your <b>device volume</b>).
              </li>
              <li>
                When the video ends, <b>do not</b> click on any other video. Place your mouse on the video, control buttons will then appear
              </li>
              <li>Please, <b>consider the description information</b> when filling the blank.</li>
            </ul>
          </div>

          <hr>

          <div class="form-group">
            <label class="question-label" for="answer-input-${0, i}">Your Question:</label>
            <crowd-input label="Please type your question here" max-length="100" name="question_1" required></crowd-input>
          </div>

          <hr>

          <div class="form-group">
            <label class="question-label" for="answer-input-${0, i}">What was the question based on: (Check all that apply):</label>
        
            <div>
                <crowd-checkbox type="checkbox" class="question_base" name="question_base" value="scene">Scene</crowd-checkbox>
                <crowd-checkbox type="checkbox" class="question_base" name="question_base" value="audio">Audio</crowd-checkbox>
                <crowd-checkbox type="checkbox" class="question_base" name="question_base" value="video_description">Video description</crowd-checkbox>
            </div>
          </div>
        
          <hr>
          <div class="form-group">
            <label class="question-label" for="answer-input-${0, i}">How do you classify your questions: (Check all that applies)</label>
            
            <div>
                <crowd-checkbox type="checkbox" class="question_type" name="question_type" value="motion-related">Motion related</crowd-checkbox>
                <crowd-checkbox type="checkbox" class="question_type" name="question_type" value="spatial-relationship">Spatial relationship</crowd-checkbox>
                <crowd-checkbox type="checkbox" class="question_type" name="question_type" value="temporal-relationship">Temporal relationship</crowd-checkbox>
                <crowd-checkbox type="checkbox" class="question_type" name="question_type" value="others">Others</crowd-checkbox>
            </div>
            <crowd-input label="If the type is Others, write what you think your question belongs to (N/A if you cannot come up with a specific type)" max-length="50" name="other_type"></crowd-input>
          </div>

          <hr>
          <div class="form-group">
            <label class="question-label" for="answer-input-${0, i}">Correct Answer:</label>
          <crowd-input label="Correct answer" max-length="100" name="correct_answer" required></crowd-input>

          <label class="question-label" for="answer-input-${0, i}">Please suggest how confident you are with your correct answer:</label>

            <div>
                <input type="radio" id="high_confidence" name="confidence" value="high_confidence" required>
                <label for="high_confidence">High confidence</label>
            </div>
            <div>
                <input type="radio" id="low_confidence" name="confidence" value="low_confidence">
                <label for="low_confidence">Low confidence</label>
            </div>

          </div>

          <hr>

          <div class="form-group">
            <div>
                <crowd-input label="Incorrect answer 1 (must be related to this clip)" max-length="100" name="incorrect_answer_1" required></crowd-input>
                <crowd-input label="Incorrect answer 2 (must be related to this clip)" max-length="100" name="incorrect_answer_2" required></crowd-input>
                <crowd-input label="Incorrect answer 3 (must be related to this clip)" max-length="100" name="incorrect_answer_3" required></crowd-input>
            </div>
          </div>

          <ul class="answer-instructions">
            <li>
              Please review the <a href="#instructions">instructions</a> (includes information about the <b>bonuses</b>);
            </li>
          </ul>

          ${showNextButton ? `<button type="button" class="btn btn-info" id="next-instance-${0, i}">
                                Go to the next Blank (or press 'Ctrl + Enter' from the text input)
                              </button>` : ""}
        </div>`);
  }

  function createInstances() {
    questions.forEach((question, i) => {
      const isExample = i === 0;
      const title = isExample ? "Example" : `Blank ${0, i}`;
      const parentId = isExample ? "example" : "instances";
      const showNextButton = !isExample && i < questions.length - 1;
      createInstanceElement(i, isExample, title, question, showNextButton, videoIds[i], descriptions[i]).appendTo(`#${0, parentId}`);
      if (showNextButton) {
        $(`#next-instance-${0, i}`).click(() => {
          window.location.href = `#instance-${0, i + 1}`;
          $(`#answer-input-${0, i + 1}`).focus();
        });
      }
    });
  }


  function collapseInstructions() {
    $("#instructions").removeAttr("open");
    window.location = "#top";
  }

  function _checkValid(name){
      var c = document.querySelector('crowd-form'); 
      var qbList = c.querySelectorAll('crowd-checkbox[name="' + name + '"]');
      var num_checked = 0;
      for (var i = 0; i < qbList.length; ++i) { 
          if (qbList[i].checked){
              num_checked += 1;
          }
      }
      if (num_checked == 0){
          if (name == "question_base"){
            alert("Please choose at least one of the answer for what your question is based on.");
          }
          else if (name == "question_type"){
            alert("Please choose at least one of the answer for your question type.");
          }
          return false;
      }
      return true;
  }


    function checkValid() {
      // Seems JQuery cannot work with crowd-checkbox for some reason
      return _checkValid("question_base") && _checkValid("question_type");
    }



  function onDomContentLoaded() {
    createInstances();
  }

  function main() {
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", onDomContentLoaded);
    } else {
      onDomContentLoaded();
    }
  }

  main();
</script>
<script src="https://www.youtube.com/iframe_api" async></script>
