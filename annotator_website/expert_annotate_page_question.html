<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"
      integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
<style>
    #instructions, li {
        color: gray;
    }

    #instructions-inner {
        margin-top: 20px;
    }

    #container {
        position: relative;
    }

    .example-answer {
        color: blue;
    }

    .counterexample-answer {
        color: red;
    }

    #collapse-instructions {
        color: grey;
    }

    .instance {
        border-radius: 15px;
        border: 4px dashed #cee3e9;
        margin-bottom: 10px;
        padding-bottom: 10px;
        padding-left: 40px;
        padding-right: 40px;
        text-align: center;
    }

    .instance-title {
        text-align: center;
    }

    .video {
        display: block;
        height: 360px;
        margin: 10px auto;
    }

    .loading-video {
        position: relative;
        top: 50%;
        text-align: center;
    }

    .video-buttons {
        margin-bottom: 5px;
    }

    .video-button {
        border-radius: 15px;
    }

    .annotate-instructions {
        list-style-type: none;
    }

    .video-relates {
        position: relative;
        text-align: center;
    }

    .question-label {
        font-size: 1.5rem;
    }

    .question {
        font-size: 2rem;
        margin: auto auto 20px auto;
        text-align: center;
    }

    .answer-input {
        border: 2px solid #C2C2C2;
        box-shadow: 1px 1px 4px #EBEBEB;
        display: inline-block;
        padding: 5px;
        font-size: 2rem;
        width: 420px;
        height: 40px;
    }

    .answer-input:hover {
        border: 2px solid black;
    }

    .answer-input::placeholder {
        color: lightgray;
    }

    .answers {
        margin-bottom: 20px;
        text-align: center;
    }

    .answer {
        font-size: 1.5rem;
        margin-bottom: 5px;
        margin-right: 10px;
    }

    .remove-answer {
        margin-left: .25rem;
        color: inherit;
        font-size: 100%;
    }

    .remove-answer:hover {
        color: white;
    }

    .alert-answer {
        margin: auto;
        width: 50%;
        text-align: center;
    }

    .answer-instructions {
        list-style-type: none;
        margin-top: 10px;
        text-align: center;
    }

    .reason-list{
      text-align: left;
      padding-left: 40px;
      border: 0 ;
      width: 100%;
    }

    .description {
      color:black;
    }

    .video-progress-bar {
      -webkit-appearance: none;
      background-color: #bdc3c7;
      border-radius: 10px;
      height: 9px;
      width: 50%;
    }

    .video-progress-bar:focus {
      outline: none;
    }

    #comments {
        border-radius: 15px;
        border: 4px dashed #cee3e9;
    }

    textarea {
      text-align: center;
    }

</style>

<div id="container" class="container">
  <h1 id="top">Video Question Answering</h1>

  <details id="instructions">
    <summary>Instructions</summary>

    <div id="instructions-inner">

      <p>We need help for this Video QA task based on video content (including the audio).
      </p>

      <h3>Basic Instructions</h3>

      <ul>
        <li>You need to provide questions with regard to the content in the videos. Please utilize the text description for the video if the description exists.
            
        <li>You need to identify the source of your question (whether it is based on the video scene, audio, or text description) and classify your questions.
        </li>

        <li>You need to provide correct answer to the question you asked.
        </li>

        <li>You need to provide video evidence (video clip) to support your question and answer.
        </li>
            
      </ul>

      <h3>How To Ask Your Question</h3>

      Questions you ask should utilize the <b>professional terminologies</b> in the text description if possible.

      <ul>
        <li>An example of using terminology is as follows:</li>
        <iframe src="https://drive.google.com/file/d/1q9-aoCsKTzXL5asNNJ8wNaJDmob5LWrG/preview" width="640" height="480" allow="autoplay"></iframe>
        <ul>
            <li><b>Text description:</b> US military <span class="example-answer">M1 Abrams tanks</span> ... </li>
            <li><b>Your Question:</b> What is the target of the <span class="example-answer">M1 Abrams tank</span> after it gets close to the river?</li>
        </ul>

      </ul>

      <h3>How to identity the Question Category</h3>

        We have some basic categories: <b>Motion, Spatial Relationship, Temporal Relationship, Reasoning, Number, Object, Time, Location, Other.</b>
        <br>
        If your questions fall into <b>multiple categories</b>, please <u>check all categories that apply</u>.
      <p>Here are some questions under each category:</p>
      <ul>
          <li><b>Motion:</b> What are the group of soldiers <span class="example-answer">doing</span>?</li>
          <li><b>Spatial Relationship:</b> What is driving <span class="example-answer">beside</span> the motorcycle?</li>
          <li><b>Temporal Relationship:</b> What happens <span class="example-answer">before</span> the black smoke rises?</li>
          <li><b>Reasoning:</b> <span class="example-answer">What makes</span> changing between targets <span class="example-answer">possible</span> for the missile?</li>
          <li><b>Number:</b> <span class="example-answer">How many</span> fighters are flying?</li>
          <li><b>Object:</b> <span class="example-answer">What is the target</span> of the bullet?</li>
          <li><b>Time:</b> <span class="example-answer">How long</span> can the missile fly?</li>
          <li><b>Location:</b> <span class="example-answer">Where</span> is the tank?</li>
          <li><b>Other:</b> What does the man require the warship to do?</li>
      </ul>

      <h3>How to provide video evidence</h3>
      <ur>
        <li> You need to provide both the <b>start point and end point</b> of your video evidence;</li>
        <li> You could use your mouse or &larr;/&rarr; key to click or drag the process bars of start point and end point. When you click or drag the bar, the above video will change accordingly, so you could locate the points according to the video screen.</li>
        <li> The end point should be greater than zero.</li>
        <li> The end point should be greater or equal to the start point.</li>
        <li> The video evidence clip (the time gap between the start point and the end point) should be <span class="example-answer">as short as possible.</span></li>
      </ur>

      <h3>HIT Acceptance</h3>

      Your HIT will be accepted based on:
      <ul>
          <li>How well your question <u>related to the video content</u></li>
          <li>Whether your question <u>involves professional terms provided in the text description</u> if possible</li>
          <li>How well your video evidence supports your question and answer.</li>
      </ul>

      <h3>Example</h3>
      
      <div id="example"></div>

      <button type="button" class="btn" id="collapse-instructions" onclick="collapseInstructions()">
        &#x25B2 Collapse instructions
      </button>
    </div>
  </details>

  <hr>

  <crowd-form onsubmit="return checkValid()">
    <div id="instances"></div>

    <div class="form-group">
      <label for="comments">Comments:</label>
      <textarea class="form-control" id="comments" name="comments" rows="10"
                placeholder="Please, write any comment/error/suggestion you have."></textarea>
    </div>

    <crowd-button id="submit-button" form-action="submit" variant="primary">Submit</crowd-button>
  </crowd-form>
</div>

<script src="https://assets.crowd.aws/crowd-html-elements.js"></script>
<script src="https://code.jquery.com/jquery-3.5.1.min.js"
        integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx"
        crossorigin="anonymous"></script>
<!--suppress CommaExpressionJS -->
<script type="text/javascript">
  // JS string interpolations clash with the Amazon Mechanical Turk template system, as they both use the syntax ${...}.
  // So we do a trick which is to put the simple string interpolation of variables inside a comma operator expression,
  // which always returns the last operand. For example, if we have to interpolate the variable "i" inside the backticks
  // (`) then we do `${0, i}`. This is basically the minimum we can write as far as we know.
  // Complex expressions usually don't need this. I tried other variants, but it seems that AMT captures spaces and plus
  // signs as valid syntax. The ternary operator is another option (`${1 ? i : 0}`), though more verbose.

  const ENTER_KEY_CODE = 13;
  const BACKSPACE_KEY_CODE = 8;

  // const videos = ["1WsdfOmM5L-7aXjyuxSqouYVkpNxXx4Lt", "${video1}", "${video2}", "${video3}", "${video4}", "${video5}"]
  //     .map(v => templateWasSubstituted(v) ? `https://drive.google.com/file/d/${0,v}/preview` :
  //      "./video0.mp4");
  const videos = ["1WsdfOmM5L-7aXjyuxSqouYVkpNxXx4Lt", "${video1}","${video2}"]
      .map(v => templateWasSubstituted(v) ? `./video0.mp4` :
       "./video1.mp4");
  const descriptions = ["A storm produces multiple <span class=\"example-answer\">landspout</span> tornadoes in far \
  eastern Colorado, north of Siebert. <span class=\"example-answer\">Landspouts</span> are a weaker type of tornado \
  caused by a storm updraft stretching low-level vorticity on a boundary.  Copyright Dan Robinson. http://stormhighway.com",
  "${description1}","${description2}", "${description3}", "${description4}", "${description5}"]
      .map(d => templateWasSubstituted(d) ? d : "N/A");


  function templateWasSubstituted(s) {
    return !s.startsWith("${") || !s.endsWith("}");
  }

  // From https://stackoverflow.com/a/6234804/1165181
  function escapeHtml(unsafe) {
    return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        // Use single quotes as AMT expands the double quote escaping and gives a syntax error otherwise:
        .replace(/"/g, '&quot;')
        .replace(/'/g, "&#039;");
  }

  function createInstanceElement(i, isExample, title, video, description) {
    return $(`
        <div class="instance" id="instance-${0, i}">
          <h2 class="instance-title">${0, title}</h2>
          <div class="video" id="video-${0, i}">
            <video width="65%" src=${0,video} controls> </video>
          </div>
        </br>
          <div class="video-relates">
            <ul class="description">
                <big><b> Text Description </b></big>: ${0,description}
            </ul>
            <ul class="annotate-instructions">
                <li>
                  Please carefully read the
                <a href="#instructions">instructions</a> before performing the task.</font>
                </li>
                <li>
                  Watch this video while you listen to its <b><u>audio</u></b> (you
                  may need to adjust your <b>device volume</b>).
                </li>
                <li>
                  When the video ends, <b>do not</b> click on any other video. Place your mouse on the video, control buttons will then appear.
                </li>
                <li>Please, consider the text description when filling the blank.</li>
              </ul>
          </div>
            
          <hr>

          <div id="inner-questions-${0,i}"></div>

        </div>`);
  }


  function createQuestionElement(i, j, isExample, isDeletable, video) {
    return $(`
        <div class="inner-question" name="inner-question-${0,i}" id="inner-question-${0,i}-${0,j}">
          ${j==0? "":"</br><hr style=\"border: 2px dashed #cee3e9;\">"}

          ${ isDeletable?`<button type="button" class="btn btn-danger" 
          id="delete-question-${0,i}-${0,j}" ${isExample? "disabled":""} > Delete This Question </button>`:""}

          <h3> Video${isExample? "-Exaple":`-${0,i}`} Question-${0,j+1} </h3>
          
          <br>
          <div class="form-group">
            <h4>Your Question:</h4>
             <textarea class="form-control" id="question-input-${0, i}-${0,j}" name="question-input-${0, i}-${0,j}" 
              rows="2" placeholder="Please type your question here" 
              ${isExample? "disabled" :""}>${isExample? "Which direction does the landspout bend towards?":""}</textarea></br>
          </div>

          <hr>

          <div>
            <h4>Which one is your question based on: (Check all that apply):</h4>
            <br>
            <div>
              <input type="checkbox" name="question-based-${0, i}-${0,j}" id="question-based-scene-${0, i}-${0,j}" 
              value="scene"/ ${isExample? "disabled checked":""}>
              <label for="question-based-scene-${0, i}-${0,j}">Scene </label>
              <input type="checkbox" name="question-based-${0, i}-${0,j}" id="question-based-audio-${0, i}-${0,j}" 
              value="audio"/ ${isExample? "disabled":""}>
              <label for="question-based-audio-${0, i}-${0,j}">Audio </label>
              <input type="checkbox" name="question-based-${0, i}-${0,j}" id="question-based-video_description-${0, i}-${0,j}" 
              value="video_description"/ ${isExample? "disabled checked":""}>
              <label for="question-based-video_description-${0, i}-${0,j}">Text description</label>
            </div>
          </div>

          <hr>

          <div>
            <h4>How do you classify your question: (Check all that apply):</h4>
            <br>
            <div>
              <input type="checkbox" name="how-${0, i}-${0,j}" id="how-motion-${0,i}-${0,j}" 
              value="Motion" ${isExample? "disabled":""}>
              <label for="how-motion-${0,i}-${0,j}">Motion</label>
              <input type="checkbox" name="how-${0,i}-${0,j}" id="how-spatial-${0,i}-${0,j}" 
              value="Spatial relationship" ${isExample? "disabled":""}>
              <label for="how-spatial-${0,i}-${0,j}">Spatial relationship</label>
              <input type="checkbox" name="how-${0,i}-${0,j}" id="how-temporal-${0,i}-${0,j}" 
              value="Temporal relationship" ${isExample? "disabled":""}>
              <label for="how-temporal-${0,i}-${0,j}">Temporal relationship</label>
              <input type="checkbox" name="how-${0,i}-${0,j}" id="how-reasoning-${0,i}-${0,j}" 
              value="Reasoning" ${isExample? "disabled":""}>
              <label for="how-reasoning-${0,i}-${0,j}">Reasoning</label>
              <br>
              <input type="checkbox" name="how-${0,i}-${0,j}" id="how-number-${0,i}-${0,j}" 
              value="Number" ${isExample? "disabled":""}>
              <label for="how-number-${0,i}-${0,j}">Number</label>
              <input type="checkbox" name="how-${0,i}-${0,j}" id="how-object-${0,i}-${0,j}" 
              value="Object" ${isExample? "disabled":""}>
              <label for="how-object-${0,i}-${0,j}">Object</label>
              <input type="checkbox" name="how-${0,i}-${0,j}" id="how-time-${0,i}-${0,j}" 
              value="Time" ${isExample? "disabled":""}>
              <label for="how-time-${0,i}-${0,j}">Time</label>
              <input type="checkbox" name="how-${0,i}-${0,j}" id="how-location-${0,i}-${0,j}" 
              value="Location" ${isExample? "disabled":""}>
              <label for="how-location-${0,i}-${0,j}">Location</label>
              <input type="checkbox" name="how-${0,i}-${0,j}" id="how-other-${0,i}-${0,j}" 
              value="Other" ${isExample? "checked disabled":""}>
              <label for="how-other-${0,i}-${0,j}">Other</label>
            </div>
            <textarea class="form-control" id="other-${0,i}-${0,j}" name="other-${0,i}-${0,j}" rows="1"
                placeholder="If select 'Other', write down what type your question belongs to (N/A if cannot come up with any specific type)"
                ${isExample? "disabled":""}>${isExample? "Direction":""}</textarea></br>
          </div>
          <hr>

          <div class="form-group">
            <h4>Correct Answer:<h4>
             <textarea class="form-control" id="correct-answer-${0,i}-${0,j}" name="correct-answer-${0,i}-${0,j}" 
              rows="1" placeholder="Correct Answer" 
              ${isExample? "disabled" :""}>${isExample? "Left":""}</textarea></br>
            <h5>Please suggest how confident you are with your correct answer:</h5>
            <br>
            <div>
              <input type="radio" name="confidence-${0,i}-${0,j}" id="confidence-high-${0,i}-${0,j}" 
              value="high" ${isExample? "checked disabled":""} />
              <label for="confidence-high-${0,i}-${0,j}">High Confidence</label>
              <input type="radio" name="confidence-${0,i}-${0,j}" id="confidence-low-${0,i}-${0,j}" 
              value="low" ${isExample? "disabled":""} />
              <label for="confidence-low-${0,i}-${0,j}">Low Confidence</label>
            </div>    
          </div>

          <hr>

          <div class="video-evidence" id="video-evidence-${0,i}-${0,j}">
            <h4>Locate the video evidence to support your question and answer:</h4>
            <div class="video">
              <video width="50%" src=${0,video} id="refer-video-${0,i}-${0,j}" controls> </video>
            </div>

            <ur class="annotate-instructions">
              <li> Provide both the <b>start point and end point</b> of your video evidence;</li>
              <li> You could use your mouse or &larr;/&rarr; key to <b> click or drag the process bars </b> of start point and end point.</li>
              <li> The end point should be <b> greater than zero. </b> </li>
              <li> The end point should be greater or equal to the start point.</li>
              <li> The video evidence clip (the time gap between the start point and the end point) should be <b>as short as possible.</b></li>
            </ul>

            <br>
            
            <label for="start-bar-${0,i}-${0,j}">Start point: </label> <input type="range" class="video-progress-bar" name="start-bar-${0,i}-${0,j}" id="start-bar-${0,i}-${0,j}"
            ${isExample? "disabled value=20.56" :"value=0"} max="100" step="0.08"><br>
            <label for="end-bar-${0,i}-${0,j}">End &nbsp;point: </label> <input type="range" class="video-progress-bar" name="end-bar-${0,i}-${0,j}" id="end-bar-${0,i}-${0,j}" 
            ${isExample? "disabled value=20.96" :"value=0"} max="100" step="0.08">

          </div>
          <hr>

          <div class="alert alert-warning alert-answer" id="alert-${0,i}-${0,j}"></div></br>

         <button type="button" class="btn btn-info" id="create-question-${0,i}-${0,j}" ${isExample? "disabled":""} >
                                Add one more question for this video</button>
        </div>`
    )
  }

  function insertQuestionElement(i, j, isExample, video){
    const isDeletable = j > 0;
    createQuestionElement(i, j, isExample, isDeletable, video).appendTo(`#inner-questions-${0,i}`);
    $(`#create-question-${0,i}-${0,j}`).click(() => {
      insertQuestionElement(i, j + 1, isExample, video);
      document.getElementById(`create-question-${0,i}-${0,j}`).disabled = true;
      });
    $(`#delete-question-${0,i}-${0,j}`).click(() => {
      if (confirm(`Do you really want to delete Video-${0,i} Question-${0,j-1} ?`)==true){
        document.getElementById(`create-question-${0,i}-${0,j-1}`).disabled = false;
        const obj =  document.getElementById(`inner-question-${0,i}-${0,j}`);
        const objparent = obj.parentNode;
        objparent.removeChild(obj);
      }
    });
    setUpInputListeners();
    setUpVideoListeners();
  }

  function createInstances() {
    videos.forEach((video, i) => {
      const isExample = i === 0;
      const title = isExample ? "Example" : `Video ${0, i}`;
      const parentId = isExample ? "example" : "instances";
      createInstanceElement(i, isExample, title, video, descriptions[i]).appendTo(`#${0, parentId}`);
      insertQuestionElement(i, 0, isExample, video);
    });
  }

  function collapseInstructions() {
    $("#instructions").removeAttr("open");
    window.location = "#top";
  }

  function questionCompleted(i,j) {
    const i_value = document.getElementById(`question-input-${0,i}-${0,j}`).value;
    return i_value != null && i_value != "";
  }

  function basedCompleted(i,j){
    return $(`[name="question-based-${0,i}-${0,j}"]:checked`).length > 0;
  }

  function howCompleted(i,j) {
    return $(`[name="how-${0,i}-${0,j}"]:checked`).length > 0;
  }

  function correctansCompleted(i,j) {
    const c_value = document.getElementById(`correct-answer-${0,i}-${0,j}`).value;
    return c_value != null && c_value != "";
  }

  function confidenceCompleted(i,j) {
    return $(`[name="confidence-${0,i}-${0,j}"]:checked`).length > 0;
  }

  function evidenceCompleted(i,j) {
    const $startbar_value = parseFloat(document.getElementById(`start-bar-${0,i}-${0,j}`).value);
    const $endbar_value = parseFloat(document.getElementById(`end-bar-${0,i}-${0,j}`).value);
    return ($endbar_value > 0) && ($startbar_value <= $endbar_value);
  }

  function blankCompleted(i,j) {
    return  questionCompleted(i,j) && basedCompleted(i,j) && howCompleted(i,j) && correctansCompleted(i,j) &&
      confidenceCompleted(i,j) && evidenceCompleted(i,j);
  }

  function videoCompleted(i) {
    return Array.from($(`[name="inner-question-${0, i}"]`)).map((_,j) => {
      return blankCompleted(i,j);
    }).every(Boolean);
  }

  function checkValid() {
    const completed = videos.map((_, i) => {
      const completi = videoCompleted(i);
      Array.from($(`[name="inner-question-${0, i}"]`)).map((aaa,j) => {
        const message1 = "Please type into your question.";
        const message2 = "Please choose at least one option."
        const message3 = "Please choose at least one option.";
        const message4 = "Please provide your correct answer.";
        const message5 = "Please select your confidence level for your correct answer."
        const message6 = "Please finish the video evidence part.\nMake sure the end time > 0.\nMake sure the end time >= the start time.";
        document.getElementById(`question-input-${0,i}-${0,j}`).setCustomValidity(questionCompleted(i,j)? "" : message1);
        document.getElementById(`question-based-scene-${0,i}-${0,j}`).setCustomValidity(basedCompleted(i,j)? "" : message2);
        document.getElementById(`how-motion-${0,i}-${0,j}`).setCustomValidity(howCompleted(i,j)? "" : message3);
        document.getElementById(`correct-answer-${0,i}-${0,j}`).setCustomValidity(correctansCompleted(i,j)? "" : message4);
        document.getElementById(`confidence-high-${0,i}-${0,j}`).setCustomValidity(confidenceCompleted(i,j)? "" : message5);
        document.getElementById(`start-bar-${0,i}-${0,j}`).setCustomValidity(evidenceCompleted(i,j)? "" : message6);
      });
      return completi;
    }).every(Boolean);


    document.getElementsByTagName("form")[0].reportValidity();

    return completed;
  }

  function checkValidationAlerts(i,j) {
    const $errorMessage = $(`#alert-${0,i}-${0,j}`);
    if (blankCompleted(i,j)) {
      $errorMessage.fadeOut("fast");
    } else {
      $errorMessage.text("Please finish above fill-in and classification tasks.").fadeIn();
    }
  }

  function setUpInputListeners() 
  {
    videos.forEach((_, i) => {
      Array.from($(`[name="inner-question-${0, i}"]`)).map((_,j) => {
        $(`[name="question-input-${0,i}-${0, j}"]`).keyup(e => 
          {
            if (e.keyCode != ENTER_KEY_CODE && e.keyCode != BACKSPACE_KEY_CODE){
              document.getElementById(`question-input-${0, i}-${0, j}`).setCustomValidity("");
              $(document.getElementById(`question-input-${0, i}-${0, j}`)).removeClass("is-invalid");
            }
            checkValidationAlerts(i,j);
          });

        Array.from($(`[name="question-based-${0, i}-${0, j}"]`)).forEach(rease => 
        { $(rease).click(e => 
          {
            document.getElementById(`question-based-scene-${0, i}-${0, j}`).setCustomValidity("");
            $(document.getElementById(`question-based-scene-${0, i}-${0, j}`)).removeClass("is-invalid");
            checkValidationAlerts(i,j);
          });
        });

        Array.from($(`[name="how-${0, i}-${0, j}"]`)).forEach(rease => 
        { $(rease).click(e => 
          {
            document.getElementById(`how-motion-${0, i}-${0, j}`).setCustomValidity("");
            $(document.getElementById(`how-motion-${0, i}-${0, j}`)).removeClass("is-invalid");
            checkValidationAlerts(i,j);
          });
        });

        $(`[name="correct-answer-${0, i}-${0, j}"]`).keyup(e => 
          {
            if (e.keyCode != ENTER_KEY_CODE && e.keyCode != BACKSPACE_KEY_CODE){
              document.getElementById(`correct-answer-${0, i}-${0, j}`).setCustomValidity("");
              $(document.getElementById(`correct-answer-${0, i}-${0, j}`)).removeClass("is-invalid");
            }
            checkValidationAlerts(i,j);
          });

        Array.from($(`[name="confidence-${0, i}-${0, j}"]`)).forEach(rease => 
        { $(rease).click(e => 
          {
            document.getElementById(`confidence-high-${0, i}-${0, j}`).setCustomValidity("");
            $(document.getElementById(`confidence-high-${0, i}-${0, j}`)).removeClass("is-invalid");
            checkValidationAlerts(i,j);
          });
        });

        checkValidationAlerts(i,j);
      });
    });
  }

  function setUpVideoListeners() {
    videos.forEach((_, i) => {
      Array.from($(`[name="inner-question-${0, i}"]`)).map((_,j) => {
        const $videoi = document.getElementById(`refer-video-${0, i}-${0, j}`);
        const $startbari = document.getElementById(`start-bar-${0, i}-${0, j}`);
        const $endbari = document.getElementById(`end-bar-${0, i}-${0, j}`);

        $($startbari).mousedown(e =>{
          $videoi.pause();
          $startbari.setCustomValidity("");
          $($startbari).removeClass("is-invalid");
          $startbari.onmousemove=function(){
            $videoi.currentTime = parseFloat($startbari.value) / 100 * parseFloat($videoi.duration);
          }
          $startbari.onmouseup=function(){
            $videoi.currentTime = parseFloat($startbari.value) / 100 * parseFloat($videoi.duration);
            checkValidationAlerts(i,j);
            $startbari.onmouseup=null;
            $startbari.onmousemove=null;
          }
          checkValidationAlerts(i,j);
        });
        $($startbari).keydown(e => {
          if (e.keyCode === 37 || e.keyCode === 39){
            $videoi.currentTime = parseFloat($startbari.value) / 100 * parseFloat($videoi.duration);
            $startbari.setCustomValidity("");
            $($startbari).removeClass("is-invalid");
          }
          checkValidationAlerts(i,j);
        });
        
        $($endbari).mousedown(e =>{
          $videoi.pause();
          $startbari.setCustomValidity("");
          $($startbari).removeClass("is-invalid");
          $endbari.onmousemove=function(){
            $videoi.currentTime = parseFloat($endbari.value) / 100 * parseFloat($videoi.duration);
          }
          $endbari.onmouseup=function(){
            $videoi.currentTime = parseFloat($endbari.value) / 100 * parseFloat($videoi.duration);
            checkValidationAlerts(i,j);
            $endbari.onmousemove=null;
            $endbari.onmouseup=null;
          }
          checkValidationAlerts(i,j);
        });
        $($endbari).keydown(e => {
          if (e.keyCode === 37 || e.keyCode === 39){
            $videoi.currentTime = parseFloat($endbari.value) / 100 * parseFloat($videoi.duration);
            $startbari.setCustomValidity("");
            $($startbari).removeClass("is-invalid");
          }
          checkValidationAlerts(i,j);
        });
      });
    });
  }

  function onDomContentLoaded() {
    createInstances();
    setUpInputListeners();
    setUpVideoListeners();
  }

  function main() {
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", onDomContentLoaded);
    } else {
      onDomContentLoaded();
    }
  }

  main();
</script>
