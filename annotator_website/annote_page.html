<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"
      integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
<style>
    #instructions, li {
        color: gray;
    }

    #instructions-inner {
        margin-top: 20px;
    }

    #container {
        position: relative;
    }

    .example-answer {
        color: blue;
    }

    .counterexample-answer {
        color: red;
    }

    #collapse-instructions {
        color: grey;
    }

    .instance {
        border-radius: 15px;
        border: 4px dashed #cee3e9;
        margin-bottom: 10px;
        padding-bottom: 10px;
        padding-left: 40px;
        padding-right: 40px;
        text-align: center;
    }

    .instance-title {
        text-align: center;
    }

    .video {
        display: block;
        height: 360px;
        margin: 10px auto;
    }

    .loading-video {
        position: relative;
        top: 50%;
        text-align: center;
    }

    .video-buttons {
        margin-bottom: 5px;
    }

    .video-button {
        border-radius: 15px;
    }

    .video-instructions {
        list-style-type: none;
    }

    .video-relates {
        position: relative;
        text-align: center;
    }

    .question-label {
        font-size: 1.5rem;
    }

    .question {
        font-size: 2rem;
        margin: auto auto 20px auto;
        text-align: center;
    }

    .answer-input {
        border: 2px solid #C2C2C2;
        box-shadow: 1px 1px 4px #EBEBEB;
        display: inline-block;
        padding: 5px;
        font-size: 2rem;
        width: 420px;
        height: 40px;
    }

    .answer-input:hover {
        border: 2px solid black;
    }

    .answer-input::placeholder {
        color: lightgray;
    }

    .answers {
        margin-bottom: 20px;
        text-align: center;
    }

    .answer {
        font-size: 1.5rem;
        margin-bottom: 5px;
        margin-right: 10px;
    }

    .remove-answer {
        margin-left: .25rem;
        color: inherit;
        font-size: 100%;
    }

    .remove-answer:hover {
        color: white;
    }

    .alert-answer {
        margin: auto;
        width: 50%;
        text-align: center;
    }

    .answer-instructions {
        list-style-type: none;
        margin-top: 10px;
        text-align: center;
    }

    .reason-list{
      text-align: left;
      padding-left: 40px;
      border: 0 ;
      width: 100%;
    }

    .description {
      color:black;
    }

    #comments {
        border-radius: 15px;
        border: 4px dashed #cee3e9;
    }

</style>

<div id="container" class="container">
  <h1 id="top">Video Caption</h1>

  <details id="instructions">
    <summary>Instructions</summary>

    <div id="instructions-inner">

      <p>We need help answering (&quot;filling&quot;) these blanks based on video content (including the audio).</p>

      <h3>Basic Instructions</h3>

      <ul>
        <li>You need to provide events that happened in videos (one event for each video). Please utilze the description for the video if description exists.
            
        <li>You need to classify your video event (whether it is related to Motion, Spatial relationship , Temporal relationship or Others).</li>
            
      </ul>

      <h3>How to provide event</h3>

      Events you provide should happen in the video, and you should utilize <b>professional terminologies</b> in the <b>video description</b> if exists.

      <ul>
        <li>An example of using terminology is as follows:</li>
        <iframe src="https://drive.google.com/file/d/1q9-aoCsKTzXL5asNNJ8wNaJDmob5LWrG/preview" width="640" height="480" allow="autoplay"></iframe>
        <ul>
            <li><b>Video description:</b> US military <span class="example-answer">M1 Abrams tanks</span> ... </li>
            <li><b>Event provided:</b> The target of the <span class="example-answer">M1 Abrams tank</span> is to cross the bridge.</li>
        </ul>

      </ul>

      <h3>How to identity event Category</h3>

      We have four basic categories: <b>Motion</b>, <b>Spatial Relationship</b>, <b>Temporal Relationship</b>, <b>Free Form</b>. Their definitions are as follows:

      <ul>
          <li><b>Motion:</b> Events ask motion of certain object in the video. </li>
          <li><b>Spatial Relationship:</b> Events involve the spatial relationship of objects. Common patterns in this type include &quot;on the left of&quot;, &quot;next to&quot;.</li>
          <li><b>Temporal Relationship:</b> Events involve temporal information about the video. Common patterns in this type include &quot;before&quot;.</li>
          <li><b>Free Form:</b> Other types of events. You need to write a category yourself if you think your event is in this type. Possible subtypes of free form questions include: reasoning, number, object, time, location, others. </li>
      </ul>

      If your events fall into <b>multiple categories</b>, please <u>check all categories that apply</u>.
      <p>Here are some events of questions under each category:</p>
      <ul>
          <li><b>Motion:</b> The group of soldiers is <span class="example-answer">running</span>.</li>
          <li><b>Spatial Relationship:</b> A truck is driving <span class="example-answer">beside</span> the motorcycle.</li>
          <li><b>Temporal Relationship:</b> A man ignited the firewood <span class="example-answer">before</span> the black smoke rises.</li>
          <li><b>Free Form:</b>
          <ul>
              <li><b>Reasoning:</b> The tornado <span class="example-answer"> causes </span> the driver to change direction.</li>
              <li><b>Number:</b> <span class="example-answer">Two</span> fighters are flying.</li>
              <li><b>Object:</b> The target of the bullet is a <span class="example-answer">dummy</span>.</li>
              <li><b>Time:</b> The missle can fly for <span class="example-answer">helf an hour.</span> </li>
              <li><b>Location:</b> The tank is <span class="example-answer"> in the pool</span>.</li>
              <li><b>Others:</b> The man require the warship to duck.</li>
          </ul></li>
      </ul>

      <h3>HIT Acceptance</h3>

      Your HIT will be accepted based on:
      <ul>
          <li>How well your event <u>related to the video content</u></li>
          <li>Whether your event <u>involves professional terms provided in the video description</u> if possible</li>
      </ul>

      <h3>Bonuses</h3>

      Need to be discussed.

      <h3>Example</h3>
      
      <div id="example"></div>

      <button type="button" class="btn" id="collapse-instructions" onclick="collapseInstructions()">
        &#x25B2 Collapse instructions
      </button>
    </div>
  </details>

  <hr>

  <crowd-form onsubmit="return checkValid()">
    <div id="instances"></div>

    <div class="form-group">
      <label for="comments">Comments:</label>
      <textarea class="form-control" id="comments" name="comments" rows="10"
                placeholder="Please, write any comment/error/suggestion you have."></textarea>
    </div>

    <crowd-button id="submit-button" form-action="submit" variant="primary">Submit</crowd-button>
  </crowd-form>
</div>

<script src="https://assets.crowd.aws/crowd-html-elements.js"></script>
<script src="https://code.jquery.com/jquery-3.5.1.min.js"
        integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx"
        crossorigin="anonymous"></script>
<!--suppress CommaExpressionJS -->
<script type="text/javascript">
  // JS string interpolations clash with the Amazon Mechanical Turk template system, as they both use the syntax ${...}.
  // So we do a trick which is to put the simple string interpolation of variables inside a comma operator expression,
  // which always returns the last operand. For example, if we have to interpolate the variable "i" inside the backticks
  // (`) then we do `${0, i}`. This is basically the minimum we can write as far as we know.
  // Complex expressions usually don't need this. I tried other variants, but it seems that AMT captures spaces and plus
  // signs as valid syntax. The ternary operator is another option (`${1 ? i : 0}`), though more verbose.

  const ENTER_KEY_CODE = 13;
  const BACKSPACE_KEY_CODE = 8;

  const videos = ["1WsdfOmM5L-7aXjyuxSqouYVkpNxXx4Lt", "${video1}", "${video2}", "${video3}", "${video4}", "${video5}"]
      .map(v => templateWasSubstituted(v) ? `https://drive.google.com/file/d/${0,v}/preview` :
       "./video1.mp4");
  const descriptions = ["A storm produces multiple <span class=\"example-answer\">landspout</span> tornadoes in far \
  eastern Colorado, north of Siebert. <span class=\"example-answer\">Landspouts</span> are a weaker type of tornado \
  caused by a storm updraft stretching low-level vorticity on a boundary.  Copyright Dan Robinson. http://stormhighway.com",
  "${description1}","${description2}", "${description3}", "${description4}", "${description5}"]
      .map(d => templateWasSubstituted(d) ? d : "N/A");


  function templateWasSubstituted(s) {
    return !s.startsWith("${") || !s.endsWith("}");
  }

  // From https://stackoverflow.com/a/6234804/1165181
  function escapeHtml(unsafe) {
    return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        // Use single quotes as AMT expands the double quote escaping and gives a syntax error otherwise:
        .replace(/"/g, '&quot;')
        .replace(/'/g, "&#039;");
  }

  function createInstanceElement(i, isExample, title, video, description, showNextButton) {
    return $(`
        <div class="instance" id="instance-${0, i}">
          <h2 class="instance-title">${0, title}</h2>
          <div class="video" id="video-${0, i}">
            <video width="65%" src=${0,video} controls> </video>
          </div>
        </br>
          <div class="video-relates">
            <ul class="description">
                <big><b> Video Description </b></big>: ${0,description}
            </ul>
            <ul class="video-instructions">
                <li>
                  Please carefully read the
                <a href="#instructions">instructions</a> before performing the task.</font>
                </li>
                <li>
                  Watch this video while you listen to its <b><u>audio</u></b> (you
                  may need to adjust your <b>device volume</b>).
                </li>
                <li>
                  When the video ends, <b>do not</b> click on any other video. Place your mouse on the video, control buttons will then appear.
                </li>
              </ul>
          </div>
            
          <hr>

          <div class="form-group">
            <label class="question-label" for="event-input-${0, i}">Fill in one video event:</label>
             <textarea class="form-control" id="event-input-${0, i}" name="event-input-${0, i}" 
              rows="2" placeholder="Please type one event here" 
              ${isExample? "disabled" :""}>${isExample? "The landspout bends toward left.":""}</textarea></br>
              </crowd-input>
          </div>

          <hr>

          <div class="how-reason-group">
            <h4>How do you classify this video event: (Check all that applies):</h4>
            <br>
            <div class="how-reason">
              <input type="checkbox" name="how-${0, i}" id="how-motion-${0, i}" 
              value="Motion related"/ ${isExample? "disabled":""}>
              <label for="how-motion-${0, i}">Motion related</label>
              <input type="checkbox" name="how-${0, i}" id="how-spatial-${0, i}" 
              value="Spatial relationship"/ ${isExample? "disabled":""}>
              <label for="how-spatial-${0, i}">Spatial relationship</label>
              <input type="checkbox" name="how-${0, i}" id="how-temporal-${0, i}" 
              value="Temporal relationship"/ ${isExample? "disabled":""}>
              <label for="how-temporal-${0, i}">Temporal relationship</label>
              <input type="checkbox" name="how-${0, i}" id="how-other-${0, i}" 
              value="Others" ${isExample? "checked disabled":""}/>
              <label for="how-other-${0, i}">Others</label>
            </div>
            <textarea class="form-control" id="others-${0, i}" name="others-${0, i}" rows="1"
                placeholder="If select 'Others', write down what type this event belongs to (N/A if cannot come up with any specific type)"
                ${isExample? "disabled":""}>${isExample? "Direction":""}</textarea></br>
          </div>
          <hr>

          <div class="video-support" id="video-support-${0, i}">
            <div class="video">
              <video width="50%" src=${0,video} id="refer-video-${0, i}" controls> </video>
            </div>
            start time: <input type="range" name="start-bar-${0, i}" id="start-bar-${0, i}" value="0" max="100" step="0.2"><br>
            end   time: <input type="range" name="end-bar-${0, i}" id="end-bar-${0, i}" value="0" max="100" step="0.2">

          </div>
          <hr>

          <div class="alert alert-warning alert-answer" id="alert-${0, i}"></div></br>

          ${showNextButton ? `<button type="button" class="btn btn-info" id="next-instance-${0, i}">
                                Go to the next Blank</button>` : ""}
        </div>`);
  }


  function createInstances() {
    videos.forEach((video, i) => {
      const isExample = i === 0;
      const title = isExample ? "Example" : `Blank ${0, i}`;
      const parentId = isExample ? "example" : "instances";
      const showNextButton = !isExample && i < videos.length - 1;
      createInstanceElement(i, isExample, title, video, descriptions[i], showNextButton).appendTo(`#${0, parentId}`);
      if (showNextButton) {
        $(`#next-instance-${0, i}`).click(() => {
          window.location.href = `#instance-${0, i + 1}`;
        });
      }
    });
  }

  function collapseInstructions() {
    $("#instructions").removeAttr("open");
    window.location = "#top";
  }

  function howCompleted(i) {
    return $(`[name="how-${0,i}"]:checked`).length > 0;
  }

  function eventCompleted(i) {
    const i_value = document.getElementById(`event-input-${0,i}`).value;
    return i_value != null && i_value != "";
  }

  function questionCompleted(i) {
    return  eventCompleted(i) && howCompleted(i);
  }

  function checkValid() {
    const completed = videos.map((_, i) => {
      const completed = questionCompleted(i);
      const message1 = completed ? "" :
       "Please type into your event.";
      document.getElementById(`event-input-${0, i}`).setCustomValidity(eventCompleted(i)? "" : message1);
      const message2 = completed ? "" :
       "Choose at least one option for the Calssification question.";
      document.getElementById(`how-motion-${0, i}`).setCustomValidity(howCompleted(i)? "" : message2);
      return completed;
    }).every(Boolean);

    document.getElementsByTagName("form")[0].reportValidity();

    return completed;
  }

  function checkValidationAlerts(i) {
    const $errorMessage = $(`#alert-${0, i}`);
    if (questionCompleted(i)) {
      $errorMessage.fadeOut("fast");
    } else {
      $errorMessage.text("Please Fill in the Event and choose at least one option "+
      "for the Calssification question.").fadeIn();
    }
  }

  function setUpInputListeners() 
  {
    videos.forEach((_, i) => 
    {
      Array.from($(`[name="how-${0, i}"]`)).forEach(rease => 
      { $(rease).click(e => 
        {
          document.getElementById(`how-motion-${0, i}`).setCustomValidity("");
          $(document.getElementById(`how-motion-${0, i}`)).removeClass("is-invalid");
          checkValidationAlerts(i);
        });
      });
      checkValidationAlerts(i);
    });
    videos.forEach((_, i) => {
      $(`[name="event-input-${0, i}"]`).keyup(e => 
        {
          if (e.keyCode != ENTER_KEY_CODE && e.keyCode != BACKSPACE_KEY_CODE){
            document.getElementById(`event-input-${0, i}`).setCustomValidity("");
            $(document.getElementById(`event-input-${0, i}`)).removeClass("is-invalid");
          }
          checkValidationAlerts(i);
        });
      checkValidationAlerts(i);
    });
  }

  function setUpVideoListeners() {
    videos.forEach((_, i) => {
      const $videoi = document.getElementById(`refer-video-${0, i}`);
      const $startbari = document.getElementById(`start-bar-${0, i}`);
      const $endbari = document.getElementById(`end-bar-${0, i}`);
      $($startbari).mousedown(e =>{
        $videoi.pause();
        console.log($videoi.frameRate);
        $startbari.onmousemove=function(){
          $videoi.currentTime = $startbari.value / 100 * $videoi.duration;
        }
        $startbari.onmouseup=function(){
          $videoi.currentTime = $startbari.value / 100 * $videoi.duration;
          $startbari.onmousemove=null;
          $startbari.onmouseup=null;
        }
      });
      $($startbari).keydown(e => {
        if (e.keyCode === 37 || e.keyCode === 39){
          $videoi.currentTime = $startbari.value / 100 * $videoi.duration;
        }
      });
      
      $($endbari).mousedown(e =>{
        $videoi.pause();
        $endbari.onmousemove=function(){
          $videoi.currentTime = $endbari.value / 100 * $videoi.duration;
        }
        $endbari.onmouseup=function(){
          $videoi.currentTime = $endbari.value / 100 * $videoi.duration;
          $endbari.onmousemove=null;
          $endbari.onmouseup=null;
        }
      });
      $($endbari).keydown(e => {
        if (e.keyCode === 37 || e.keyCode === 39){
          $videoi.currentTime = $endbari.value / 100 * $videoi.duration;
        }
      });


    });
  }

  function onDomContentLoaded() {
    createInstances();
    setUpInputListeners();
    setUpVideoListeners();
  }

  function main() {
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", onDomContentLoaded);
    } else {
      onDomContentLoaded();
    }
  }

  main();
</script>
